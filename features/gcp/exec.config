#!/usr/bin/env bash
set -Eeuo pipefail

sed -i "s/^#NTP=/NTP=metadata.google.internal/g" /etc/systemd/timesyncd.conf
ln -sf /usr/share/zoneinfo/UTC /etc/localtime

# cannot execute startup script in /tmp, usr /var/tmp instead
sed -i 's/^run_dir =\s*/run_dir = \/var\/tmp/g' /etc/default/instance_configs.cfg

cat >>/etc/ssh/sshd_conf <<EOF

# Needed for google oslogin
AuthorizedKeysCommand /usr/libexec/google_authorized_keys
AuthorizedKeysCommandUser root
EOF

# ensure that binaries for guest-config are linked properly
ln -sf /usr/bin/google_set_hostname /etc/dhcp/dhclient-exit-hooks.d/google_set_hostname
